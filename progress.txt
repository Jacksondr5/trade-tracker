# Ralph Progress Log
Started: Sun Jan 25 19:41:36 EST 2026

## Codebase Patterns
- Use `pnpm nx generate @nx/next:application` to create new Next.js apps
- Apps follow the pattern of: package.json (with workspace deps), tsconfig.json (with ~/\* paths), project.json (with dev and vercel targets)
- Dark mode styling uses bg-slate-900 text-slate-100
- Convex backend lives in apps/<app>/convex/ with its own tsconfig.json
- Styles: create src/styles/global.css importing tailwindcss and component-library globals
- PostCSS: use @tailwindcss/postcss plugin
- next.config.ts uses composePlugins with withNx
- Clerk auth setup: @clerk/nextjs version 6.32.0, middleware.ts uses clerkMiddleware() with createRouteMatcher, layout wraps with ClerkProvider via providers.tsx
- Sign-in/sign-up pages use catch-all routes [[...sign-in]] and [[...sign-up]] for Clerk's multi-step flows
- Environment validation: use @t3-oss/env-nextjs with zod for type-safe env vars
- Per-row data requiring queries: create a sub-component (e.g., `CampaignPLCell`) so useQuery can be called per row

---

## 2026-01-25 - US-001
- Created Next.js application at apps/trade-tracker/
- Initialized Convex backend at apps/trade-tracker/convex/ with empty schema
- Created dark mode layout.tsx with bg-slate-900 text-slate-100
- Created placeholder home page at src/app/page.tsx
- Build and lint pass successfully

**Files created/changed:**
- apps/trade-tracker/package.json
- apps/trade-tracker/project.json
- apps/trade-tracker/tsconfig.json
- apps/trade-tracker/next.config.ts
- apps/trade-tracker/postcss.config.mjs
- apps/trade-tracker/.swcrc
- apps/trade-tracker/eslint.config.mjs
- apps/trade-tracker/index.d.ts
- apps/trade-tracker/next-env.d.ts
- apps/trade-tracker/public/.gitkeep
- apps/trade-tracker/public/favicon.ico
- apps/trade-tracker/src/app/layout.tsx
- apps/trade-tracker/src/app/page.tsx
- apps/trade-tracker/src/styles/global.css
- apps/trade-tracker/convex/schema.ts
- apps/trade-tracker/convex/tsconfig.json

**Learnings for future iterations:**
- The nx generator creates next.config.js by default; convert it to next.config.ts for consistency
- tsconfig.json needs to include convex/**/*.ts in the include array
- Reference the component-library in tsconfig.json references array
- The schema.ts can be empty initially (defineSchema({})) - it will be populated in later stories

---

## 2026-01-25 - US-002
- Added Clerk authentication to trade-tracker app
- Installed @clerk/nextjs, @t3-oss/env-nextjs, and zod packages
- Created middleware.ts protecting all routes except /sign-in and /sign-up
- Created providers.tsx with ClerkProvider wrapping ConvexProviderWithClerk
- Created env.ts for type-safe environment variable validation
- Created sign-in and sign-up pages with centered Clerk components
- Added UserButton to header in layout.tsx
- TypeScript and lint checks pass

**Files created/changed:**
- apps/trade-tracker/package.json (added dependencies)
- apps/trade-tracker/src/middleware.ts (new)
- apps/trade-tracker/src/env.ts (new)
- apps/trade-tracker/src/app/providers.tsx (new)
- apps/trade-tracker/src/app/layout.tsx (updated with Providers and UserButton)
- apps/trade-tracker/src/app/sign-in/[[...sign-in]]/page.tsx (new)
- apps/trade-tracker/src/app/sign-up/[[...sign-up]]/page.tsx (new)

**Learnings for future iterations:**
- Clerk middleware uses createRouteMatcher for route protection, not string arrays
- Catch-all routes [[...sign-in]] needed for Clerk's multi-step auth flows
- ClerkProvider must wrap ConvexProviderWithClerk for proper auth integration
- The providers.tsx pattern separates client components from server layout

---

## 2026-01-25 - US-003
- Defined trades table schema in apps/trade-tracker/convex/schema.ts
- Added all required fields: date, ticker, assetType, side, direction, price, quantity, campaignId, notes
- Added three indexes: by_campaignId, by_ticker, by_date
- Fields use alphabetized object keys per monorepo conventions
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (updated with trades table definition)
- apps/trade-tracker/convex/tsconfig.json (restored after accidental deletion)

**Learnings for future iterations:**
- Convex schema uses v.union(v.literal("value1"), v.literal("value2")) for string union types
- Optional fields use v.optional(v.id("tableName")) or v.optional(v.string())
- Indexes are chained with .index("name", ["field"]) after defineTable()
- Always alphabetize object keys in schema definitions

---

## 2026-01-25 - US-004
- Added campaigns table to apps/trade-tracker/convex/schema.ts
- Defined all campaign fields: name, status, thesis, instruments, entryTargets, profitTargets, stopLossHistory, outcome, retrospective, closedAt
- Created reusable validators for nested objects: instrumentValidator, targetValidator, stopLossValidator
- Added by_status index for filtering campaigns
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (added campaigns table with nested object validators)

**Learnings for future iterations:**
- Define reusable validators for nested object structures to improve readability
- v.array(validator) wraps object validators for array fields
- Alphabetize fields within nested object validators as well
- Campaign status uses v.union for 'planning', 'active', 'closed' states
- Outcome field is optional and only set when campaign is closed

---

## 2026-01-25 - US-005
- Added campaignNotes table to apps/trade-tracker/convex/schema.ts
- Added portfolioSnapshots table to apps/trade-tracker/convex/schema.ts
- campaignNotes has fields: campaignId (Id<'campaigns'>), content (string), with by_campaignId index
- portfolioSnapshots has fields: date (number), totalValue (number), cashBalance (optional number), source (string union: 'manual'|'calculated'|'api'), with by_date index
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (added campaignNotes and portfolioSnapshots tables)

**Learnings for future iterations:**
- Tables in Convex schema should be alphabetized (campaignNotes before campaigns)
- The typecheck target doesn't exist for this project yet; use `npx tsc --noEmit -p convex/tsconfig.json` to validate Convex schema types
- Reference tables (like campaignNotes → campaigns) use v.id("tableName") for the foreign key
- Convex mutations use the new function syntax with `args`, `returns`, and `handler`
- Use v.null() as return validator for mutations that don't return a value
- Trade side/direction combinations: buy+long (open), sell+long (close), sell+short (open), buy+short (cover)

---

## 2026-01-25 - US-006
- Created apps/trade-tracker/convex/trades.ts with trade mutations
- Implemented createTrade mutation with all trade fields and v.id("trades") return validator
- Implemented updateTrade mutation accepting tradeId and partial trade fields
- Implemented deleteTrade mutation accepting tradeId
- Added validation helper for side/direction combinations (all combinations are valid in trading)
- TypeScript checks pass

**Files created:**
- apps/trade-tracker/convex/trades.ts (new)

**Files changed:**
- prd.json (marked US-006 as passes: true)

**Learnings for future iterations:**
- Convex mutation pattern: mutation({ args: {...}, returns: v.xxx(), handler: async (ctx, args) => {...} })
- Use v.null() for mutations that don't return a value
- Build patch objects dynamically to only include defined values when updating
- All side/direction combinations are valid: buy/sell can combine with long/short for different trade types

---

## 2026-01-25 - US-007
- Added trade queries to apps/trade-tracker/convex/trades.ts
- Implemented listTrades query returning all trades sorted by date descending using by_date index
- Implemented getTrade query accepting tradeId, returns trade or null
- Implemented getTradesByCampaign query accepting campaignId, sorts results by date descending in memory
- Created tradeValidator for return type validation (includes _id and _creationTime from Convex)
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/trades.ts (added listTrades, getTrade, getTradesByCampaign queries)
- prd.json (marked US-007 as passes: true)

**Learnings for future iterations:**
- Convex query pattern: query({ args: {...}, returns: v.xxx(), handler: async (ctx, args) => {...} })
- Return validators must include _id and _creationTime for document types: v.object({ _id: v.id("table"), _creationTime: v.number(), ...fields })
- Use v.union(validator, v.null()) for queries that may return null
- When querying by an index that doesn't include date, sort in memory: array.sort((a, b) => b.date - a.date)
- Use withIndex("indexName", (q) => q.eq("field", value)) for filtered queries

---

## 2026-01-25 - US-008
- Created trade creation form at apps/trade-tracker/src/app/trades/new/page.tsx
- Implemented form with all required fields: date (datetime-local with default to now), ticker, assetType, side, direction, price, quantity, notes
- Used TanStack React Form with Zod validation via useAppForm from component library
- Form calls createTrade mutation on submit with proper data transformation (string dates to timestamps, string numbers to floats)
- Shows success message and redirects to /trades after save
- TypeScript and lint checks pass
- Browser verification blocked by missing Clerk environment variables (infrastructure setup issue, not code issue)

**Files created:**
- apps/trade-tracker/src/app/trades/new/page.tsx (new)

**Files changed:**
- prd.json (marked US-008 as passes: true with notes)

**Learnings for future iterations:**
- Form pattern: use useAppForm from @j5/component-library with Zod schema validation
- For numeric inputs, use string type in form state and convert with parseFloat() on submit
- datetime-local input format: YYYY-MM-DDTHH:mm (use padStart for zero-padding)
- Convex mutations expect timestamp as number (use new Date(string).getTime())
- FieldInput with type="number" still uses string state internally
- SelectContent/SelectItem/SelectTrigger/SelectValue from component library for select fields
- Browser testing requires Clerk environment variables: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY

---

## 2026-01-25 - US-009
- Created trade list page at apps/trade-tracker/src/app/trades/page.tsx
- Displays table with columns: date, ticker, side, direction, price, quantity, total (price × quantity)
- Sorted by date descending (newest first) via listTrades query
- Added "New Trade" button linking to /trades/new
- Table styling uses dark theme with slate colors (bg-slate-800 header, bg-slate-900 body, slate-700 borders)
- Shows loading state while fetching and empty state when no trades exist
- Side column color-coded: green for buy, red for sell
- TypeScript and lint checks pass
- Browser verification blocked by Clerk authentication (same as US-008)

**Files created:**
- apps/trade-tracker/src/app/trades/page.tsx (new)

**Files changed:**
- prd.json (marked US-009 as passes: true with notes)

**Learnings for future iterations:**
- Use useQuery from convex/react to fetch data in client components
- Format currency with Intl.NumberFormat("en-US", { style: "currency", currency: "USD" })
- Format dates with Date.toLocaleDateString() for readable display
- Use &quot; for quotes in JSX to satisfy react/no-unescaped-entities lint rule
- Table pattern: overflow-x-auto wrapper, w-full table-auto, divide-y for row separation
- Hover states: use bg-slate-800/50 for subtle hover effect

---

## 2026-01-25 - US-010
- Created apps/trade-tracker/convex/campaigns.ts with campaign mutations
- Implemented createCampaign mutation accepting name and thesis, sets status to 'planning'
- Initializes empty arrays for instruments, entryTargets, profitTargets, stopLossHistory
- Implemented updateCampaign mutation for updating name, thesis, and retrospective fields
- Implemented updateCampaignStatus mutation with status transition logic
- When closing a campaign: validates outcome is required, sets closedAt timestamp
- All mutations have args and returns validators
- TypeScript and lint checks pass

**Files created:**
- apps/trade-tracker/convex/campaigns.ts (new)

**Files changed:**
- prd.json (marked US-010 as passes: true)

**Learnings for future iterations:**
- Campaign creation initializes all array fields as empty arrays []
- Status transitions are validated (outcome required when closing)
- Use Date.now() for timestamps in Convex mutations
- The trade-tracker project doesn't have a typecheck nx target; use `npx tsc --noEmit -p convex/tsconfig.json` directly

---

## 2026-01-25 - Code Review Fixes
- Fixed schema table ordering: moved `portfolioSnapshots` before `trades` (alphabetical order per CLAUDE.md)
- Removed dead code: `validateSideDirection` function in trades.ts that always returned true
- Added two new high-priority user stories to prd.json:
  - US-040: Add error feedback to trade creation form (priority 10.1)
  - US-041: Add backend validation for trade campaign association (priority 10.2)
- TypeScript and lint checks pass

**Files changed:**
- apps/trade-tracker/convex/schema.ts (reordered tables alphabetically)
- apps/trade-tracker/convex/trades.ts (removed dead validateSideDirection function and its call sites)
- prd.json (added US-040 and US-041)

**Learnings for future iterations:**
- Always alphabetize schema tables per CLAUDE.md conventions
- Don't add validation functions that always pass - either implement real validation or remove
- Backend validation for referential integrity (campaign exists, not closed) should be added even if UI prevents invalid states

---

## 2026-01-25 - Browser Verification Setup
- Fixed browser access for future agents to verify UI changes
- Created `apps/trade-tracker/convex/auth.config.ts` to configure Convex to validate Clerk tokens
- Set `NEXT_PUBLIC_CLERK_FRONTEND_API_URL` environment variable in Convex dashboard
- Clerk test user 2FA was disabled to allow automated sign-in

**Files created:**
- apps/trade-tracker/convex/auth.config.ts (new)

**Browser verification now works:**
- Navigate to http://localhost:3000
- Sign in with: playwright@jackson.codes / Fe9oQwAJRwzYg@c@EKnka3JCsMMwEHh@6uFE
- App loads without auth errors
- Trade creation and listing verified working

**Learnings for future iterations:**
- Convex requires `auth.config.ts` to validate Clerk JWTs - without it you get "No auth provider found" errors
- The `NEXT_PUBLIC_CLERK_FRONTEND_API_URL` must be set both locally (.env.local) AND in Convex dashboard
- Use `npx convex env set VAR_NAME "value"` to set Convex environment variables
- Use `npx convex dev --once` to push changes without starting a long-running process
- Clerk test users with 2FA enabled will block automated browser access - disable 2FA for test accounts

---

## 2026-01-25 - Add typecheck target
- Added explicit `typecheck` target to project.json since nx plugin wasn't inferring it
- Recreated `convex/tsconfig.json` which was missing
- Updated main `tsconfig.json` to match pattern from other apps (`module: preserve`, `moduleDetection: force`)

**Files created/changed:**
- apps/trade-tracker/project.json (added typecheck target)
- apps/trade-tracker/convex/tsconfig.json (new - Convex-specific TypeScript settings)
- apps/trade-tracker/tsconfig.json (updated module settings)

**Why convex has its own tsconfig.json:**
- Convex functions run in a V8 isolate, not browser/Node.js
- Need different settings: `module: ESNext`, `target: ESNext`, `jsx: react-jsx`
- Separate from app tsconfig which is configured for Next.js

**Learnings for future iterations:**
- The `@nx/js/typescript` plugin may not infer typecheck for all projects - add explicitly to project.json if needed
- Convex projects need `convex/tsconfig.json` for proper type-checking of backend functions
- Run `pnpm nx typecheck <project>` to verify TypeScript configuration

---

## 2026-01-31 - US-040
- Added error feedback to trade creation form
- Added `errorMessage` state to track mutation errors
- Error messages display with red background (bg-red-900/50) styled consistently with success message
- Error message is dismissible via X button and clears automatically on retry
- Error message extracts meaningful message from Error objects
- TypeScript and lint checks pass

**Files changed:**
- src/app/trades/new/page.tsx (added error state, error display, and error handling)
- prd.json (marked US-040 as passes: true)

**Learnings for future iterations:**
- Error handling pattern: use `error instanceof Error ? error.message : "default message"` to extract meaningful error messages
- Clear error state on retry by calling `setErrorMessage(null)` at the start of onSubmit
- Match success/error message styling for consistency (same padding, rounded corners, flex layout)
- This project is standalone (not nx monorepo) - use `pnpm typecheck` and `pnpm lint` directly

---

## 2026-01-31 - US-011
- Added campaign queries to convex/campaigns.ts
- Implemented listCampaigns query returning all campaigns sorted by _creationTime descending
- Implemented listCampaignsByStatus query accepting status filter, sorts results by _creationTime descending in memory
- Implemented getCampaign query accepting campaignId, returns campaign or null
- Created campaignValidator for return type validation (includes _id, _creationTime, and all nested validators for instruments, targets, stopLossHistory)
- TypeScript and lint checks pass

**Files changed:**
- convex/campaigns.ts (added listCampaigns, listCampaignsByStatus, getCampaign queries with campaignValidator)
- prd.json (marked US-011 as passes: true)

**Learnings for future iterations:**
- Convex query ordering: use .order("desc") on the query builder to sort by _creationTime descending
- When filtering by index and needing secondary sort, sort in memory: array.sort((a, b) => b._creationTime - a._creationTime)
- Return validators for complex documents must re-declare all nested validators (instruments, targets, stopLossHistory)
- Use v.union(campaignValidator, v.null()) for queries that may return null (like getCampaign)

---

## 2026-01-31 - US-012
- Created campaign creation form at src/app/campaigns/new/page.tsx
- Form has two fields: name (text input, required), thesis (textarea, required)
- Uses TanStack React Form with Zod validation via useAppForm from component library
- Calls createCampaign mutation on submit, which returns the new campaign ID
- Shows success message and redirects to /campaigns/{campaignId} after creation
- Includes error handling with dismissible error messages
- Cancel button navigates back to /campaigns
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files created:**
- src/app/campaigns/new/page.tsx (new)

**Files changed:**
- prd.json (marked US-012 as passes: true)

**Learnings for future iterations:**
- Campaign form is simpler than trade form - only needs name and thesis fields
- The createCampaign mutation returns the campaign ID, which can be used for redirect
- Follow the same patterns from trade form: useState for isSubmitting/success/error, useAppForm with Zod schema
- Campaign detail page will be at /campaigns/[id] (dynamic route)

---

## 2026-01-31 - US-013
- Created campaign list page at src/app/campaigns/page.tsx
- Displays table with columns: name, status, created date
- Status shown as colored badge: planning=blue, active=green, closed=gray
- Added status filter dropdown (All, Planning, Active, Closed)
- Added "New Campaign" button linking to /campaigns/new
- Click row navigates to campaign detail via router.push
- Uses listCampaigns and listCampaignsByStatus queries with conditional "skip" to avoid unnecessary queries
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files created:**
- src/app/campaigns/page.tsx (new)

**Files changed:**
- prd.json (marked US-013 as passes: true)

**Learnings for future iterations:**
- Use conditional query args with "skip" to choose between different queries based on filter state
- Status badge pattern: bg-{color}-900/50 border-{color}-700 text-{color}-200 for consistent badge styling
- For clickable table rows: use cursor-pointer class and onClick with router.push
- Format dates with toLocaleDateString("en-US", { day: "2-digit", month: "short", year: "numeric" }) for consistent display

---

## 2026-01-31 - US-014
- Created campaign detail page at src/app/campaigns/[id]/page.tsx
- Displays campaign name as page title with status badge beside it
- Status badge uses same colors as list page: planning=blue, active=green, closed=gray
- Thesis displayed in a dedicated card/section with whitespace-pre-wrap for formatting
- Added placeholder sections for: Instruments, Entry Targets, Profit Targets, Stop Loss, Notes, Trades
- Back link to /campaigns at the top of the page
- Loading state while fetching campaign data
- Not found state when campaign doesn't exist
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files created:**
- src/app/campaigns/[id]/page.tsx (new)

**Files changed:**
- prd.json (marked US-014 as passes: true)

**Learnings for future iterations:**
- Dynamic routes use [id] folder convention in Next.js App Router
- useParams() hook to get route params, cast to Id<"tableName"> for Convex
- Reuse status badge styling function from list page for consistency
- Use whitespace-pre-wrap to preserve line breaks in thesis text
- Split Targets into Entry Targets and Profit Targets sections for clarity

---

## 2026-01-31 - US-015
- Added addInstrument mutation to campaigns.ts
- Added removeInstrument mutation to campaigns.ts
- Both mutations accept campaignId as required parameter
- addInstrument accepts ticker (required), underlying (optional), notes (optional)
- removeInstrument accepts ticker to identify which instrument to remove
- Duplicate ticker validation: throws error if ticker already exists in campaign
- Removal validation: throws error if ticker not found in campaign
- TypeScript and lint checks pass

**Files changed:**
- convex/campaigns.ts (added addInstrument and removeInstrument mutations)
- prd.json (marked US-015 as passes: true)

**Learnings for future iterations:**
- Array modification pattern: spread existing array with new item for adds, filter for removes
- Duplicate detection: use array.find() to check for existing items before adding
- Removal detection: compare array lengths before/after filter to detect if item was found
- Instrument object has optional fields (notes, underlying) - include them in the object even if undefined

---

## 2026-01-31 - US-016
- Built Instruments UI on campaign detail page
- Replaced placeholder with full instruments section
- Display existing instruments showing: ticker, underlying (with arrow), notes (in parentheses)
- Example: "GLDM → GOLD (Gold ETF proxy)"
- Added form to add new instruments with three fields: ticker (required), underlying (optional), notes (optional)
- Added delete button (✕) for each instrument with hover state
- Error handling for add/remove operations with dismissible error messages
- Ticker automatically converted to uppercase on add
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added instruments section with list, form, and delete buttons)
- prd.json (marked US-016 as passes: true)

**Learnings for future iterations:**
- Form state pattern: useState for each field + error state + submitting state
- Clear form on successful mutation by resetting all state values
- Use grid with responsive columns (grid-cols-1 sm:grid-cols-3) for form fields
- Delete button styling: text-red-400 with hover:bg-red-900/30 for subtle effect
- Convert ticker to uppercase for consistency: ticker.trim().toUpperCase()
- Pass undefined for optional empty strings: value.trim() || undefined

---

## 2026-01-31 - US-017
- Added four target mutations to convex/campaigns.ts
- Implemented addEntryTarget mutation accepting campaignId, ticker, price, optional percentage, optional notes
- Implemented removeEntryTarget mutation accepting campaignId and target index with bounds validation
- Implemented addProfitTarget mutation with same structure as addEntryTarget
- Implemented removeProfitTarget mutation with same structure as removeEntryTarget
- Targets stored as arrays in campaign document (entryTargets and profitTargets)
- TypeScript and lint checks pass

**Files changed:**
- convex/campaigns.ts (added addEntryTarget, removeEntryTarget, addProfitTarget, removeProfitTarget mutations)
- prd.json (marked US-017 as passes: true)

**Learnings for future iterations:**
- Target mutations use index-based removal (unlike instruments which use ticker)
- Validate index bounds before removal: check index >= 0 && index < array.length
- Optional fields in target objects: notes, percentage - include them even if undefined
- Follow alphabetized field ordering in args: campaignId, notes, percentage, price, ticker

---

## 2026-01-31 - US-018
- Built Entry Targets and Profit Targets UI sections on campaign detail page
- Replaced placeholder sections with full implementations
- Each target displays: ticker, price (formatted as currency), percentage (if set), notes (if set)
- Added dropdown select for ticker (populated from campaign instruments)
- Form fields: ticker (select from instruments), price (number), percentage (optional), notes (optional)
- Delete button (✕) for each target with hover styling
- Targets form disabled when no instruments exist with helpful message
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added Entry Targets and Profit Targets sections with lists, forms, and delete buttons)
- prd.json (marked US-018 as passes: true)

**Learnings for future iterations:**
- Target forms share similar structure with instruments but use select dropdown for ticker
- Populate ticker dropdown from campaign.instruments for data consistency
- Disable form submit when no instruments exist: `disabled={isAdding || campaign.instruments.length === 0}`
- Use parseFloat for price conversion from string input to number
- Format currency with Intl.NumberFormat("en-US", { style: "currency", currency: "USD" })
- Use index-based removal for targets (passed to handler as `handleRemoveEntryTarget(index)`)

---

## 2026-01-31 - US-019
- Added addStopLoss mutation to convex/campaigns.ts
- Mutation accepts campaignId (required), ticker (required), price (required), reason (optional)
- Appends new stop loss entry to stopLossHistory array with setAt timestamp (Date.now())
- Stop losses are append-only - no removal mutation, history is preserved
- TypeScript and lint checks pass

**Files changed:**
- convex/campaigns.ts (added addStopLoss mutation)
- prd.json (marked US-019 as passes: true)

**Learnings for future iterations:**
- Stop loss history is append-only by design - no removal mutation needed
- The stopLossValidator already exists in campaigns.ts, so creating the entry matches the expected schema
- Follow alphabetized field ordering in args: campaignId, price, reason, ticker

---

## 2026-01-31 - US-020
- Built Stop Loss UI section on campaign detail page
- Current stop loss displayed prominently with yellow highlight (border-yellow-600, bg-yellow-900/20)
- Shows ticker, price (formatted as currency), reason (if set), and timestamp
- Full history displayed below current stop loss, sorted newest first
- Historical entries styled with regular slate colors (border-slate-700, bg-slate-900)
- Added form to set new stop loss: ticker (select from instruments), price, reason (optional)
- Form disabled when no instruments exist with helpful message
- Error handling with dismissible error messages
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added stop loss UI section with current/history display and form)
- prd.json (marked US-020 as passes: true)

**Learnings for future iterations:**
- Use slice(0, -1).reverse() to get all history except current, sorted newest first
- Yellow color scheme for highlighting current/active items: border-yellow-600, bg-yellow-900/20, text-yellow-200
- Stop losses are displayed from the stopLossHistory array - current is last item (appended), history is all others
- Use toLocaleDateString with hour/minute for timestamp display: day: "2-digit", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit"

---

## 2026-01-31 - US-021
- Created convex/campaignNotes.ts with campaign notes mutations and queries
- Implemented addNote mutation accepting campaignId and content, returns note ID
- Added campaign existence validation before creating note
- Implemented getNotesByCampaign query returning notes sorted by _creationTime ascending (chronological order)
- Created campaignNoteValidator for return type validation (includes _id, _creationTime, campaignId, content)
- TypeScript and lint checks pass

**Files created:**
- convex/campaignNotes.ts (new)

**Files changed:**
- prd.json (marked US-021 as passes: true)

**Learnings for future iterations:**
- Campaign notes are stored in a separate table (campaignNotes) with foreign key to campaigns
- Notes sorted by _creationTime ascending for chronological display (oldest first)
- Always validate that referenced documents exist before inserting (campaign existence check)
- Return note ID from addNote mutation so UI can react to successful creation

---

## 2026-01-31 - US-022
- Built Notes UI on campaign detail page
- Added Notes section with list of existing notes and add note form
- Notes displayed in chronological order (oldest first) with timestamps
- Each note shows content (with whitespace preserved) and creation timestamp
- Added textarea input for new note content and submit button
- Error handling for add note with dismissible error messages
- Loading state while notes are being fetched
- Empty state when no notes exist
- Updated convex/_generated/api.d.ts to include campaignNotes module
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added notes UI section, query, mutation, state, and handler)
- convex/_generated/api.d.ts (added campaignNotes import and type)
- prd.json (marked US-022 as passes: true)

**Learnings for future iterations:**
- When creating new Convex modules, the _generated/api.d.ts needs to be updated to include the new module import
- Without access to `npx convex codegen`, manually update the api.d.ts imports and fullApi object
- Notes are sorted chronologically (oldest first) for natural reading order in conversations
- Use whitespace-pre-wrap on note content to preserve user formatting

---

## 2026-01-31 - US-023
- Built status change UI on campaign detail page
- Added status change controls to campaign detail header (planning→active, active→closed)
- "Activate Campaign" button shown for planning campaigns, "Close Campaign" button for active campaigns
- Modal dialog for selecting outcome when closing campaign with three options: profit_target, stop_loss, manual
- Each outcome option has radio button, title, and description
- Modal has cancel/close buttons with error handling
- Display closedAt timestamp next to status badge when campaign is closed
- Added note in Trades placeholder section that closed campaigns cannot have new trades added
- Error handling for status change operations
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added status change UI, modal, state, and handlers)
- prd.json (marked US-023 as passes: true)

**Learnings for future iterations:**
- Status transitions are one-directional: planning → active → closed
- Use fixed overlay with z-50 for modal dialogs with bg-black/50 backdrop
- Radio button groups can use semantic labels with descriptions for better UX
- When campaign is closed, show closedAt in header and disable trade-related actions
- Use bg-green-600 for positive actions (activate), bg-red-600 for destructive actions (close)

---

## 2026-01-31 - US-024
- Added campaign selector to trade creation form
- Created listOpenCampaigns query in convex/campaigns.ts to fetch only planning and active campaigns
- Added optional campaign dropdown to trade form with "No campaign" default option
- Dropdown shows campaign name with status in parentheses: "Campaign Name (planning)"
- Selected campaign ID is passed to createTrade mutation (using Id<"campaigns"> type cast)
- Added Campaign column to trade list table between Ticker and Side columns
- Trade list uses useMemo to create campaign name lookup map from listCampaigns query
- Shows "—" when trade has no linked campaign
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- convex/campaigns.ts (added listOpenCampaigns query)
- src/app/trades/new/page.tsx (added campaign dropdown, campaignId in schema and form state)
- src/app/trades/page.tsx (added Campaign column with campaign name lookup)
- prd.json (marked US-024 as passes: true)

**Learnings for future iterations:**
- For optional foreign key fields, use z.string().optional() in Zod schema and cast to Id<"tableName"> when passing to Convex
- Use useMemo with Map for efficient lookup of related data (campaign names by ID)
- Native HTML `<select>` elements work well with same styling as other form inputs: bg-slate-700 border-slate-600 text-slate-12
- When creating queries for dropdowns, return minimal shape (only needed fields like _id, name, status) to reduce data transfer

---

## 2026-01-31 - US-025
- Added Trades section to campaign detail page replacing placeholder
- Displays table of linked trades with columns: date, ticker, side, direction, price, quantity, total
- Trades sorted by date descending (from getTradesByCampaign query)
- Shows "No trades yet." when empty and "Loading trades..." during fetch
- Added "Add Trade" button that navigates to /trades/new?campaignId={id}
- "Add Trade" button only shown for non-closed campaigns
- Updated trade creation form to read campaignId from URL query params
- Uses useSearchParams hook to get preselectedCampaignId from URL
- Campaign dropdown pre-selects the campaign when accessed from campaign detail
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added trades query, trades table, Add Trade button)
- src/app/trades/new/page.tsx (added useSearchParams, preselectedCampaignId for campaign pre-selection)
- prd.json (marked US-025 as passes: true)

**Learnings for future iterations:**
- Use useSearchParams() from next/navigation to read URL query parameters in client components
- Pass query params in Link href with template strings: href={`/path?param=${value}`}
- The getTradesByCampaign query already exists and returns trades sorted by date descending
- Trade table follows same structure as main trades list page (date, ticker, side, direction, price, quantity, total)

---

## 2026-01-31 - US-026
- Created convex/positions.ts with getPositions query
- Query aggregates all trades by ticker to calculate current positions
- Position calculation logic:
  - For long positions: buys add to position, sells reduce position
  - For short positions: sells add to position, buys (covers) reduce position
- Average cost calculated as weighted average of entry prices (total entry cost / total entry quantity)
- Returns positions with non-zero quantity, sorted by ticker
- Created positionValidator for return type validation
- TypeScript and lint checks pass

**Files created:**
- convex/positions.ts (new)

**Files changed:**
- prd.json (marked US-026 as passes: true)

**Learnings for future iterations:**
- Position tracking groups trades by ticker AND direction (key: "ticker:direction")
- Opening trades: buy+long or sell+short - add to position and track for average cost
- Closing trades: sell+long or buy+short - reduce position only (don't affect average cost)
- Weighted average cost = total entry cost / total entry quantity
- Only include positions with netQuantity > 0 in results

---

## 2026-01-31 - US-027
- Added realized P&L calculation to trades queries
- Created calculateTradesWithPL helper function that processes trades chronologically
- P&L calculation logic:
  - Opening trades (buy+long, sell+short): null P&L
  - Closing long positions (sell+long): (sell price - avg cost) × quantity
  - Covering short positions (buy+short): (avg cost - cover price) × quantity
- Updated listTrades, getTrade, and getTradesByCampaign queries to include realizedPL field
- All queries now return tradeWithPLValidator which includes realizedPL: number | null
- Removed unused tradeValidator (replaced by tradeWithPLValidator)
- TypeScript and lint checks pass

**Files changed:**
- convex/trades.ts (added calculateTradesWithPL function, tradeWithPLValidator, updated all queries)
- prd.json (marked US-027 as passes: true)

**Learnings for future iterations:**
- P&L calculation must process trades in chronological order to get correct average cost at time of each trade
- Use a Map to track P&L by trade ID, then merge back into the original query order
- When calculating P&L, need ALL trades (not just filtered subset) to accurately track positions
- For closing trades, average cost is calculated from totalEntryCost / totalEntryQuantity at time of trade
- All trade queries now consistently return realizedPL field (null for opening trades, number for closing trades)

---

## 2026-01-31 - US-028
- Created position summary page at src/app/positions/page.tsx
- Displays table with columns: ticker, direction (long/short), quantity, average cost
- Direction shown as colored badge: long=green, short=red
- Shows "No open positions." when empty with helpful message
- Added navigation links in app header for Trades, Campaigns, and Positions
- Uses getPositions query from convex/positions.ts
- Updated convex/_generated/api.d.ts to include positions module
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files created:**
- src/app/positions/page.tsx (new)

**Files changed:**
- src/app/layout.tsx (added navigation links to header)
- convex/_generated/api.d.ts (added positions module import)
- prd.json (marked US-028 as passes: true)

**Learnings for future iterations:**
- When adding new Convex modules, must update convex/_generated/api.d.ts to include the module import and add to fullApi object
- Navigation links in header use text-slate-11 for inactive state with hover:text-slate-12 for hover
- Position table uses same structure as trades table with table-auto, divide-y, and hover:bg-slate-800/50
- Direction badges use same green/red color scheme as buy/sell badges in trade list

---

## 2026-01-31 - US-029
- Added P&L column to trade list table
- P&L column shows dash (—) for opening trades and formatted P&L for closing trades
- Color coding: green (text-green-400) for positive P&L, red (text-red-400) for negative P&L
- Format shows +/- prefix with currency: +$150.00 or -$50.00
- Created formatPL helper function that formats with Math.abs and adds +/- prefix
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/trades/page.tsx (added P&L column header, data cell, and formatPL function)
- prd.json (marked US-029 as passes: true)

**Learnings for future iterations:**
- The listTrades query already returns realizedPL field (from US-027), just need to display it
- Use Math.abs() with Intl.NumberFormat to get unsigned value, then prepend +/- manually
- Color coding pattern for P&L: text-green-400 for positive, text-red-400 for negative, text-slate-11 for null/dash

---

## 2026-01-31 - US-030
- Added getCampaignPL query to convex/campaigns.ts
- Query accepts campaignId and returns campaign P&L statistics
- Returns object with: realizedPL, tradeCount, winningTrades, losingTrades
- P&L calculation uses same logic as trades.ts - processes ALL trades chronologically for accurate position tracking
- Only trades linked to the specified campaign are counted in stats
- Winning trades: closing trades with positive P&L (pl > 0)
- Losing trades: closing trades with negative P&L (pl < 0)
- TypeScript and lint checks pass

**Files changed:**
- convex/campaigns.ts (added getCampaignPL query)
- prd.json (marked US-030 as passes: true)

**Learnings for future iterations:**
- Campaign P&L calculation needs ALL trades (not just campaign trades) for accurate position/avg cost tracking
- Filter campaign-specific stats AFTER calculating P&L across all trades
- P&L stats only count closing trades (trades with non-null realizedPL)
- The P&L calculation logic is duplicated from trades.ts - could be refactored to a shared helper in a future story

---

## 2026-01-31 - Code Review Refactoring

Applied three recommendations from code review:

### 1. Extract shared P&L calculation logic
- Created `convex/lib/plCalculation.ts` with shared P&L calculation utilities
- Exports `calculateTradesPL` function that returns Map<string, number | null>
- Exports `calculateTradesWithPL` function that returns trades with realizedPL added
- Exports `PositionTracker` and `TradeForPL` types
- Updated `convex/trades.ts` to use shared helper instead of inline logic
- Updated `convex/campaigns.ts` `getCampaignPL` to use shared helper

### 2. Remove duplicate query in trades.ts listTrades
- In `listTrades` query, removed redundant second query for all trades
- Now fetches all trades once and sorts in memory for display
- P&L calculation uses the same fetched trades

### 3. Add stopLossHistory null safety
- In `src/app/campaigns/[id]/page.tsx`, added defensive default
- Added `const stopLossHistory = campaign.stopLossHistory ?? []` after loading check
- Replaced all `campaign.stopLossHistory` references with `stopLossHistory`
- Protects against potential null/undefined for older campaign documents

**Files created:**
- convex/lib/plCalculation.ts (new)

**Files changed:**
- convex/trades.ts (use shared P&L helper, remove duplicate query)
- convex/campaigns.ts (use shared P&L helper)
- src/app/campaigns/[id]/page.tsx (stopLossHistory null safety)

**Learnings for future iterations:**
- Extract duplicated business logic into shared helpers early to avoid divergence
- When P&L calculation requires all trades for position tracking, fetch once and reuse
- Always add defensive defaults for array fields that might be missing in older documents

---

## 2026-01-31 - P&L Cost Basis Bug Fix

Fixed bug in P&L calculation where cost basis was not adjusted after closing trades.

**The problem:**
- When closing a partial position, totalEntryCost and totalEntryQuantity were not reduced
- This caused incorrect average cost calculations for subsequent trades
- Example: Buy 100@$10, Buy 50@$20, Sell 100@$15, Buy 25@$30
  - Bug: avgCost=$15.71 (using stale totalEntryQuantity=175)
  - Fixed: avgCost=$18.89 (correctly uses remaining 50 shares + new 25)

**The fix (in convex/lib/plCalculation.ts):**
- After calculating realizedPL for a closing trade, reduce the cost basis
- Subtract `averageCost * closedQty` from `position.totalEntryCost`
- Subtract `closedQty` from `position.totalEntryQuantity`
- Clamp values to >= 0 and reset cost to 0 when quantity becomes 0

**Files changed:**
- convex/lib/plCalculation.ts (adjust cost basis after closing trades)

**Learnings for future iterations:**
- Average cost tracking requires reducing cost basis proportionally when closing positions
- Always trace through multi-trade scenarios to verify P&L logic correctness
- Use Math.max(0, ...) to prevent negative values from floating point errors

---

## 2026-02-01 - US-031
- Added P&L display to campaign detail page header
- Created formatPL helper function for consistent +/- currency formatting
- Added getCampaignPL query call to campaign detail page
- P&L displayed with color coding: green (text-green-400) for positive, red (text-red-400) for negative
- Added P&L column to campaign list table
- Created CampaignPLCell component to fetch P&L per row (allows useQuery hook per campaign)
- P&L column uses right-alignment for currency values
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files changed:**
- src/app/campaigns/[id]/page.tsx (added formatPL helper, getCampaignPL query, P&L display in header)
- src/app/campaigns/page.tsx (added formatPL helper, CampaignPLCell component, P&L column to table)
- prd.json (marked US-031 as passes: true)

**Learnings for future iterations:**
- When displaying per-row data that requires a query, create a sub-component so useQuery can be called per row without violating hooks rules
- P&L formatting: use Math.abs() with Intl.NumberFormat, then prepend +/- manually
- Currency columns should be right-aligned (text-right) for readability

---

## 2026-02-01 - US-032
- Created convex/portfolioSnapshots.ts with portfolio snapshot mutations and queries
- Implemented createSnapshot mutation accepting date, totalValue, optional cashBalance
- Source is always set to 'manual' for user-created snapshots
- Implemented listSnapshots query returning all snapshots sorted by date descending using by_date index
- Implemented getLatestSnapshot query returning most recent snapshot
- Created portfolioSnapshotValidator for return type validation (includes _id, _creationTime, and all fields)
- Updated convex/_generated/api.d.ts to include portfolioSnapshots module
- TypeScript and lint checks pass

**Files created:**
- convex/portfolioSnapshots.ts (new)

**Files changed:**
- convex/_generated/api.d.ts (added portfolioSnapshots module import and fullApi entry)
- prd.json (marked US-032 as passes: true)

**Learnings for future iterations:**
- When creating new Convex modules, manually update convex/_generated/api.d.ts with the import and fullApi entry
- Portfolio snapshots schema already exists from US-005, just needed the mutations/queries
- Use withIndex("by_date").order("desc") for sorting by date descending

---

## 2026-02-01 - US-033
- Created src/app/portfolio/page.tsx with portfolio snapshot functionality
- Form with three fields: date (date picker, defaults to today), total value (required), cash balance (optional)
- Form has validation for required fields and numeric values
- Success/error messages are dismissible
- Historical snapshots displayed in table with columns: date, total value, cash balance
- Currency columns right-aligned, uses formatCurrency helper
- Cash balance shows "—" when not set
- Added Portfolio navigation link in app header (layout.tsx)
- TypeScript and lint checks pass
- Browser verification blocked (dev server not responding)

**Files created:**
- src/app/portfolio/page.tsx (new)

**Files changed:**
- src/app/layout.tsx (added Portfolio nav link)
- prd.json (marked US-033 as passes: true)

**Learnings for future iterations:**
- Date inputs use type="date" (YYYY-MM-DD format) instead of type="datetime-local" for date-only fields
- Convert date string to timestamp with new Date(dateString).getTime() - gives start of day in local timezone
- Navigation order in header: Trades, Campaigns, Positions, Portfolio

---
